\section{Результаты работы и ускорение}
Чтобы проверить эффективность работы алгоритма параллельной записи, описанного в \ref{sec1}, проведено сравнение с алгоритмом стандартной печати: \vspace{12pt}
\begin{center}
\texttt{
\begin{tabular}{ll}
 $\quad$ & for (int i = 0; i < n;)\\
 $\quad$ & $\,\,$ \{ \\
 $\quad$ & $\,\,\quad$ for (int j = 0; j < m; j++, i++)\\
 $\quad$ & $\,\,\quad\quad$ fprintf (f, '' \%.16f'', a[i]);\\
 $\quad$ & $\,\,\quad$ fprintf (f, ''$\mathtt{\backslash n}$''); \\
 $\quad$ & $\,\,$ \} \\
\end{tabular}}\\
\end{center}
Здесь $n$ -- размер массива, а $m$ -- количество чисел, записываемых в одну строку.
Стандартная печать будет записывать числа с 16 знаками после запятой.

Для всех дальнейших тестов было сделано следующее.
Оба выходных файла, полученные работой параллельного алгоритма и стандартного, считывались вновь. 
Затем вычислялась разница между считанным числами.
Во всех запусках погрешность не превышала машинной точности, что говорит о точности работы реализованного алгоритма.

\subsection{Тест 1. Массив случайных чисел} \label{test1}
Оба алгоритма запускались на одних и тех же массивах вещественных чисел, сгенерированных случайным образом. 
Этот тест полезен тем, что в реальных моделях данные могут задаваться каким-либо распределением (например, нормальным), где все числа являются вещественными и различными.

Описанный в Разделе \ref{sec1} алгоритм параллельной записи запускался с разным числом потоков на машине с 6 ядрами.

Время работы в секундах для обоих алгоритмов приведено в Таблице 1.
Также в таблице приведен размер полученного текстового файла.
Под числом потоков понимается число потоков-обработчиков. 
Таким образом реально задействовано на два потока больше, так как помимо обработчиков есть еще управляющий поток и печатающий.
\begin{center}
\begin{longtable}{||c|c|c|c|c|c|c||}
\hline
\hline
Размер & \multicolumn{4}{c|}{Число потоков} & Стандартная & Размер\\
\hhline{~|-|-|-|-|~|~|}
массива & 6 & 4 & 2 & 1 & печать &файла\\
\hline
\hline
 & 0.593 & 0.880 & 1.620 & 3.196 & 4.256 & \\
\hhline{~|-|-|-|-|-|~|}
$10^7$   & 0.562 & 0.841 & 1.612 & 3.239 & 4.176 & 245 MB \\
\hhline{~|-|-|-|-|-|~|}
 & 0.530 & 0.802 & 1.502 & 3.052 & 4.188 &\\
\hline
&2.571& 4.044 & 7.812 & 15.37 & 22.47 & \\
\hhline{~|-|-|-|-|-|~|}
$5 \cdot 10^7$  & 2.634 & 4.273 & 8.214 & 16.30 & 21.11 &  1.2 GB\\
\hhline{~|-|-|-|-|-|~|}
 & 2.689 & 4.179 & 7.822 & 15.32 & 20.89 & \\
\hline
 & 5.219 & 8.276 & 15.67 & 32.46 & 41.71 & \\
\hhline{~|-|-|-|-|-|~|}
$10^8$  & 5.077 & 7.970 & 15.30 & 30.57 & 41.78 & 2.4 GB\\
\hhline{~|-|-|-|-|-|~|}
& 5.189 & 8.078 & 15.37 & 30.75 & 41.96 & \\
\hline
 & 41.12 & 49.15 & 75.23 & 148.91 & 200.94 & \\
\hhline{~|-|-|-|-|-|~|}
$5 \cdot 10^8$ & 40.23 & 50.08 & 75.92 & 149.08 & 200.33 & 12 GB\\
\hhline{~|-|-|-|-|-|~|}
 & 41.23 & 49.16 & 74.92 & 148.52 & 200.69 & \\
\hline
\hline
\end{longtable}
\small{Таблица 1.}
\end{center}

Также стоит заметить, что отношение времени работы при увеличении количества потоков заметно уменьшается, и при увеличении размеров массива стремится к обратному отношению числа потоков.
Наглядно зависимость времени от числа потоков для массива размером $10^8$ изображена на Рисунке \ref{pic3}.
\begin{figure}[h!]
\begin{minipage}[h]{0.5\linewidth}
\center{\includegraphics[width=1\linewidth]{./pics/time.png}}
\end{minipage}
\hspace{10pt}
\begin{minipage}[h]{0.5\linewidth}
\center{\includegraphics[width=1\linewidth]{./pics/time40.png}}
\end{minipage} 
\caption{Зависимость времени работы от числа потоков.} \label{pic3}
\end{figure}

Тот факт, что отношения работы не строго пропорциональны, объясняется несколькими фактами.
Во-первых, часть времени, хоть и небольшую при таких данных, занимала запись на диск.
Во-вторых, не все потоки могли быть все время задействованными.
Некоторые потоки могли обращаться к пустой очереди и тем самым тратить время на ожидание.

Среднее ускорение работы алгоритма по сравнению со стандартной печатью приведены в Таблице 2.
Ускорение на одном потоке демонстрирует ускорение работы \textsf{Grisu2} по сравнению со стандартной печатью.
\begin{center}
\begin{tabular}{||c|c|c|c|c||}
\hline
\hline
Размер & \multicolumn{4}{c||}{Число потоков}\\
\hhline{~|-|-|-|-|}
массива & 6 & 4 & 2 & 1 \\
\hline
$10^7$ &  7.49  & 5.00 & 2.67 & 1.33 \\
\hline
$5 \cdot 10^7$ & 8.17 & 5.16 & 2.70 & 1.37 \\
\hline
$10^8$ & 8.10 & 5.16 & 2.71 & 1.34\\
\hline
$5 \cdot 10^8$ & 4.91 & 4.06 & 2.66 & 1.35\\
\hline
\hline
\end{tabular}
\\
\vspace{14pt}
\small{Таблица 2.}
\end{center}

Заметим, что при увеличении массива до определенного размера, ускорение возрастает, а затем спадает.
Первое объясняется тем, что с увеличением объема данных, потоки простаивают меньше.
Второй факт будет рассмотрен подробнее в пункте \ref{subsec2:3}.

\subsection{Тест 2. Целые числа} \label{test2}
Массив состоит из сгенерированных случайным образом целых чисел от 0 до 1000.
С помощью этого теста, во-первых, можно проверить работу с целыми числами, а во-вторых, убедиться в том, что \textsf{Grisu2} отбрасывает ненужные нули.

\begin{center}
\begin{longtable}{||c|c|c|c|c|c|c||}
\hline
\hline
Размер & \multicolumn{4}{c|}{Число потоков} & Станд. & Размер\\
\hhline{~|-|-|-|-|~|~|}
массива & 6  & 4 & 2 & 1 & печать & файла\\
\hline
\hline
 & 0.213 & 0.322 & 0.643 & 1.297 & 5.300  &\\
\hhline{~|-|-|-|-|-|}
$10^7$ & 0.216 & 0.320 & 0.649 & 1.284 & 5.245  &56 MB / 205 MB \\
\hhline{~|-|-|-|-|-|}
 & 0.219 & 0.337 & 0.650 & 1.321 & 5.312  &\\
\hline
& 1.052 & 1.664 & 3.319 & 6.362 & 27.93  &\\
\hhline{~|-|-|-|-|-|}
$5 \cdot 10^7$& 1.069  & 1.675 & 3.334 & 6.375 & 29.46  &295 MB / 1 GB\\
\hhline{~|-|-|-|-|-|}
& 1.071  & 1.662 & 3.340 & 6.490 & 29.43  &\\
\hline
 & 2.057 &  3.374 & 6.618 & 12.61 & 55.04 & \\
\hhline{~|-|-|-|-|-|}
$10^8$ & 2.018 & 3.309 & 6.712 & 12.63 & 55.70  & 590 MB / 2 GB \\
\hhline{~|-|-|-|-|-|}
 & 2.012 & 3.248 & 6.601 & 13.66 & 56.31  &\\
\hline
 & 10.82 & 16.68 & 32.14 & 62.94 & 283.61  &\\
\hhline{~|-|-|-|-|-|}
$5 \cdot 10^8$ & 10.91 & 16.68 & 32.20 & 64.08 & 290.70  &2.9 GB / 10 GB\\
\hhline{~|-|-|-|-|-|}
 & 10.15 & 16.45 & 32.09 & 64.12 & 287.54  &\\
\hline
\hline
\end{longtable}
\small{Таблица 3.}
\end{center}

Заметим, что размер файла, полученного с помощью нового алгоритма гораздо меньше размера файла, полученного стандартной печатью, так как отброшены лишние нули.
За счет этого ускорение возросло по сравнению с Тестом \ref{test1}.

\begin{center}
\begin{tabular}{||c|c|c|c|c||}
\hline
\hline
Размер & \multicolumn{4}{c|}{Число потоков}\\
\hhline{~|-|-|-|-|}
массива & 6 & 4 & 2 & 1 \\
\hline
$10^7$  & 24.47  & 16.19 & 8.17 & 4.06 \\
\hline
$5 \cdot 10^7$ & 27.20 & 17.36& 8.69 & 4.51 \\
\hline
$10^8$ & 27.44 & 16.82 & 8.38 & 4.29 \\
\hline
$5 \cdot 10^8$ & 27.03  & 17.30 & 8.93& 4.51 \\
\hline
\hline
\end{tabular}
\\
\vspace{14pt}
\small{Таблица 4.}
\end{center}

\subsection{Тест 3. Повторяющиеся числа}
Сгенерируем массив чисел из 0 и 1.
В этом случае все последовательности одинаковых подряд идущих чисел будут сворачиваться в короткую строку вида \texttt{n*x}.

Были сделаны замеры времени аналогично предыдущим тестам.
Время работы в секундах приведено в Таблице 3.
Также приведен размер файла <<со звездами>>, полученным быстрым алгоритмом, и размер файла <<без звезд>>, полученного алгоритмом стандартной печати.
\begin{center}
\begin{longtable}{||c|c|c|c|c|c|c||}
\hline
\hline
Размер & \multicolumn{4}{c|}{Число потоков} & Станд. & Размер \\
\hhline{~|-|-|-|-|~|~|}
массива & 6 & 4 & 2 & 1 & печать  & файла\\
\hline
\hline
& 0.112 & 0.181 & 0.339 & 0.652 & 3.445  &\\
\hhline{~|-|-|-|-|-|}
$10^7$ & 0.109 & 0.159 & 0.310 & 0.604 & 3.322  & 24 MB / 187 MB \\
\hhline{~|-|-|-|-|-|}
& 0.119 & 0.168 & 0.329 & 0.661 & 3.460  &\\
\hline
& 0.521 & 0.843 & 1.630 & 2.983 & 16.91  &\\
\hhline{~|-|-|-|-|-|}
$5 \cdot 10^7$ & 0.549 & 0.841 & 1.643 & 3.067 & 17.30  & 123 MB / 936 MB\\
\hhline{~|-|-|-|-|-|}
& 0.530 & 0.833 & 1.612 & 2.875 & 16.96 & \\
\hline
& 1.178 & 1.748 & 3.343 & 6.056 & 36.19 &\\
\hhline{~|-|-|-|-|-|}
$10^8$ & 1.152 & 1.678 & 3.209 & 5.959 & 36.38  & 245 MB / 1.8 GB\\
\hhline{~|-|-|-|-|-|}
& 1.163 & 1.689 & 3.290 & 6.039 &  36.41  &\\
\hline
& 5.720 & 8.354 & 15.82 & 31.50 & 182.22 &\\
\hhline{~|-|-|-|-|-|}
$5 \cdot 10^8$ &5.714 & 8.346 & 15.71 & 31.29 & 182.00  & 1.2 GB / 9.4 GB\\
\hhline{~|-|-|-|-|-|}
& 5.816 & 8.418 & 15.92 & 31.69 & 183.52  &\\
\hline
\hline
\end{longtable}
\small{Таблица 5.}
\end{center}

Среднее ускорение приведено в Таблице 6.

\begin{center}
\begin{tabular}{||c|c|c|c|c||}
\hline
\hline
Размер & \multicolumn{4}{c|}{Число потоков}\\
\hhline{~|-|-|-|-|}
массива & 6 & 4 & 2& 1 \\
\hline
$10^7$  & 30.08 & 20.13 & 10.46 & 5.33 \\
\hline
$5 \cdot 10^7$ & 31.98 & 20.32 & 10.47 & 5.74 \\
\hline
$10^8$ & 31.20 & 21.31 & 11.07 & 6.03 \\
\hline
$5 \cdot 10^8$ & 31.75 & 21.81 & 11.54 & 5.80 \\
\hline
\hline
\end{tabular}
\\
\vspace{14pt}
\small{Таблица 6.}
\end{center}

\subsection{Тест 4. Огромные массивы} \label{subsec2:3}
Здесь, как и в первом случае, числа будут генерироваться случайным образом.
Сравнивать будем стандартную печать и алгоритм, запущенный на 12 (+2) потоках.

Помимо обычного запуска, проведем и запуск с записью не на диск, а в разделяемую память \textit{shared-memory}.
Как известно, разделяемая память является самым быстром средством обмена данными между процессами.

Ранее говорилось, что скорость диска влияет на печать, но не всегда сильно.
За счет сравнения записи на диск и в \textit{shared-memory} можно оценить, это влияние.

Далее на Рисунке \ref{grap} приведена зависимость времени работы от размера массива.
\begin{figure}[h!]
\center{\includegraphics[width=1\linewidth]{./pics/graphics.png}}
\caption{
1 -- стандартная печать с записью на диск;
2 -- стандартная печать с записью в разделяемую память;
3 -- алгоритм параллельной печати с записью на диск;
4 -- алгоритм параллельной печати с записью в разделяемую память.} \label{grap}
\end{figure}

Сначала хочется заметить, что стандартная печать не сильно замедляется при записи в диск. 
Все время скорость работы диска была порядка 40--50 Mb/s.
Диск фактически не оказывает никакого существенного влияния на работу.

Из графиков также видно, что при записи в \textit{shared-memory} отношение времени работы стандартного алгоритма и ускоренного постоянно, так как оба графика -- прямые.
Это значит, что ускорение одинаково на всех данных.

Однако, такого нельзя сказать в случае записи на диск.
На графике в точке $4 \cdot 10^8$ (9.6 GB) происходит излом: начинает ощущаться влияние диска. Именно это мы и наблюдали в Тесте 1 -- ускорение немного упало при $5 \cdot 10^8$.
С этого момента печать начинает упираться в диск.
При запуске тестов было замечено, что скорость записи на диск временами достигает 800-900 Mb/s.
Из-за слишком больших файлов (так файл при размере массива $10^9$ достигает 24 GB) создается очередь из буферов на печать.
Потоки-обработчики обрабатывают буферы быстрее, чем производится сама печать.
Разница между третьим и четвертым графиком -- накладные расходы на работу диска.

