\section{Результаты работы и ускорение}
Чтобы проверить эффективность работы алгоритма параллельной записи, описанного в \ref{sec1}, проведено сравнение с алгоритмом стандартной печати: \vspace{12pt}
\begin{center}
\texttt{
\begin{tabular}{ll}
 $\quad$ & for (int i = 0; i < n;)\\
 $\quad$ & $\,\,$ \{ \\
 $\quad$ & $\,\,\quad$ for (int j = 0; j < m; j++, i++)\\
 $\quad$ & $\,\,\quad\quad$ fprintf (f, '' \%.16f'', a[i]);\\
 $\quad$ & $\,\,\quad$ fprintf (f, ''$\mathtt{\backslash n}$''); \\
 $\quad$ & $\,\,$ \} \\
\end{tabular}}\\
\end{center}
Здесь $n$ -- размер массива, а $m$ -- количество чисел, записываемых в одну строку.
Стандартная печать будет записывать числа с 16 знаками после запятой.

Для всех дальнейших тестов было сделано следующее.
Оба выходных файла, полученные работой параллельного алгоритма и стандартного, считывались вновь. 
Затем вычислялась разница между считанным числами.
Во всех запусках погрешность не превышала машинной точности, что говорит о точности работы реализованного алгоритма.

\subsection{Тест 1. Массив случайных чисел} \label{test1}
Оба алгоритма запускались на одних и тех же массивах вещественных чисел, сгенерированных случайным образом. 
Этот тест полезен тем, что в реальных моделях данные могут задаваться каким-либо распределением (например, нормальным), где все числа являются вещественными и различными.

Описанный в Разделе \ref{sec1} алгоритм параллельной записи запускался с разным числом потоков.

Время работы в секундах для обоих алгоритмов приведено в Таблице 1.
Под числом потоков понимается число потоков-обработчиков. 
Таким образом реально задействовано на два потока больше, так как помимо обработчиков есть еще управляющий поток и печатающий.
\begin{center}
\begin{tabular}{||c|c|c|c|c|c|c||}
\hline
\hline
Размер & \multicolumn{4}{c|}{Число потоков} & Стандартная & Размер\\
\hhline{~|-|-|-|-|~|~|}
массива & 12 & 8 & 4 & 1 & печать &файла\\
\hline
\hline
 & 0.496 & 0.550 & 0.880 & 3.196 & 4.256 & \\
\hhline{~|-|-|-|-|-|~|}
$10^7$   & 0.467 & 0.500 & 0.841 & 3.239 & 4.176 & 245 MB \\
\hhline{~|-|-|-|-|-|~|}
 & 0.457 & 0.473 & 0.802 & 3.052 & 4.188 &\\
\hline
&2.294 & 2.420 & 4.044 & 15.37 & 22.47 & \\
\hhline{~|-|-|-|-|-|~|}
$5 \cdot 10^7$  & 2.208 & 2.446 & 4.273 & 16.30 & 21.11 &  1.2 GB\\
\hhline{~|-|-|-|-|-|~|}
 & 2.096 & 2.339 & 4.179 & 15.32 & 20.89 & \\
\hline
 & 4.320 & 5.065 & 8.276 & 32.46 & 41.71 & \\
\hhline{~|-|-|-|-|-|~|}
$10^8$  & 4.302 & 5.034 & 7.970 & 30.57 & 41.78 & 2.4 GB\\
\hhline{~|-|-|-|-|-|~|}
& 4.544 & 5.362& 8.078 & 30.75 & 41.96 & \\
\hline
 & 38.07 & 41.17 & 49.15 & 148.91 & 200.94 & \\
\hhline{~|-|-|-|-|-|~|}
$5 \cdot 10^8$ & 40.09 & 41.56 & 50.08 & 149.08 & 200.33 & 12 GB\\
\hhline{~|-|-|-|-|-|~|}
 & 38.17& 41.73& 49.16 & 148.52 & 200.69 & \\
\hline
\hline
\end{tabular}\\ \vspace{10pt}
\small{Таблица 1.}
\end{center}

Также стоит заметить, что отношение времени работы при увеличении количества потоков заметно уменьшается, и при увеличении размеров массива стремится к обратному отношению числа потоков.
Наглядно зависимость времени от числа потоков для массива размером $10^8$ изображена на Рисунке \ref{pic3}.
\begin{figure}[h!]
\begin{minipage}[h]{0.5\linewidth}
\center{\includegraphics[width=1\linewidth]{./pics/time.png}}
\end{minipage}
\hspace{10pt}
\begin{minipage}[h]{0.5\linewidth}
\center{\includegraphics[width=1\linewidth]{./pics/time40.png}}
\end{minipage} 
\caption{Зависимость времени работы от числа потоков.} \label{pic3}
\end{figure}

То, что отношения работы не строго пропорциональны объясняется несколькими фактами.
Во-первых, часть времени, хоть и небольшую при таких данных, занимала запись на диск.
Во-вторых, не все потоки могли быть все время задействованными.
Некоторые потоки могли обращаться к пустой очереди и тем самым тратить время на ожидание.

Среднее ускорение работы алгоритма по сравнению со стандартной печатью приведены в следующей Таблице 2.
Ускорение на одном потоке показывает ускорение при работе \textsf{Grisu2}.
\begin{center}
\begin{tabular}{||c|c|c|c|c||}
\hline
\hline
Размер & \multicolumn{4}{c||}{Число потоков}\\
\hhline{~|-|-|-|-|}
массива & 12 & 8 & 4 & 1 \\
\hline
$10^7$ &  8.88 & 8.28 & 5.00 & 1.33 \\
\hline
$5 \cdot 10^7$ & 9.77& 8.95 & 5.16 & 1.37 \\
\hline
$10^8$ & 9.52 & 8.11 & 5.16 & 1.34\\
\hline
$5 \cdot 10^8$ & 5.18 & 4.83 & 4.06 & 1.35\\
\hline
\hline
\end{tabular}
\\\vspace{10pt}
\small{Таблица 2.}
\end{center}

Заметим, что при увеличении массива до определенного размера, ускорение возрастает, а затем спадает.
Первое объясняется тем, что с увеличением объема данных, потоки простаивают меньше.
Второй факт будет рассмотрен подробнее в пункте \ref{subsec2:3}.

\subsection{Тест 2. Целые числа} \label{test2}
Массив состоит из сгенерированных случайным образом целых чисел от 0 до 1000.
С помощью этого теста, во-первых, можно проверить работу с целыми числами, а во-вторых, убедиться в том, что \textsf{Grisu2} отбрасывает ненужные нули.

\begin{center}
\begin{tabular}{||c|c|c|c|c|c|c||}
\hline
\hline
Размер & \multicolumn{4}{c|}{Число потоков} & Станд. & Размер\\
\hhline{~|-|-|-|-|~|~|}
массива & 12 & 8 & 4 & 1 & печать & файла\\
\hline
\hline
 & 0.213 & 0.245 & 0.322 & 1.297 & 5.300  &\\
\hhline{~|-|-|-|-|-|}
$10^7$ & 0.216 & 0.243 & 0.320 & 1.284 & 5.245  &56 MB / 205 MB \\
\hhline{~|-|-|-|-|-|}
 & 0.219 & 0.248 & 0.337 & 1.321 & 5.312  &\\
\hline
& 1.052 & 1.159 & 1.664 & 6.362 & 27.93  &\\
\hhline{~|-|-|-|-|-|}
$5 \cdot 10^7$& 1.069 & 1.243 & 1.675 & 6.375 & 29.46  &295 MB / 1 GB\\
\hhline{~|-|-|-|-|-|}
& 1.071  & 1.208 & 1.662 & 6.490 & 29.43  &\\
\hline
 & 2.057 & 2.315 & 3.374 & 12.61 & 55.04 & \\
\hhline{~|-|-|-|-|-|}
$10^8$ & 2.018 & 2.245 & 3.309 & 12.63 & 55.70  & 590 MB / 2 GB \\
\hhline{~|-|-|-|-|-|}
 & 2.012 & 2.229 & 3.248 & 13.66 & 56.31  &\\
\hline
 & 10.82 & 11.45 & 16.68 & 62.94 & 283.61  &\\
\hhline{~|-|-|-|-|-|}
$5 \cdot 10^8$ & 10.91 & 11.86 & 16.68 & 64.08 & 290.70  &2.9 GB / 10 GB\\
\hhline{~|-|-|-|-|-|}
 & 10.15 & 11.12 & 16.45 & 64.12 & 287.54  &\\
\hline
\hline
\end{tabular}
\\\vspace{10pt}
\small{Таблица 3.}
\end{center}

Заметим, что размер файла, полученного с помощью нового алгоритма гораздо меньше размера файла, полученного стандартной печатью, так как отброшены лишние нули.
За счет этого ускорение возросло по сравнению с Тестом \ref{test1}.

\begin{center}
\begin{tabular}{||c|c|c|c|c||}
\hline
\hline
Размер & \multicolumn{4}{c|}{Число потоков}\\
\hhline{~|-|-|-|-|}
массива & 12 & 8 & 4 & 1 \\
\hline
$10^7$  & 24.47 & 21.54 & 16.19 & 4.06 \\
\hline
$5 \cdot 10^7$ & 27.20 & 24.04 & 17.36 & 4.51 \\
\hline
$10^8$ & 27.44 & 24.61 & 16.82 & 4.29 \\
\hline
$5 \cdot 10^8$ & 27.03 & 25.03 & 17.30 & 4.51 \\
\hline
\hline
\end{tabular}
\\\vspace{10pt}
\small{Таблица 4.}
\end{center}

\subsection{Тест 3. Повторяющиеся числа}
Сгенереруем массив чисел из 0 и 1.
В этом случае все последовательности одинаковых подряд идущих чисел будут сворачиваться в короткую строку вида \texttt{n*x}.

Были сделаны замеры времени аналогично предыдущим тестам.
Время работы в секундах приведено в Таблице 3.
Также приведен размер файла ''со звездами'', полученным быстрым алгоритмом, и размер файла ''без звезд'', полученного алгоритмом стандартной печати.
\begin{center}
\begin{tabular}{||c|c|c|c|c|c|c||}
\hline
\hline
Размер & \multicolumn{4}{c|}{Число потоков} & Станд. & Размер \\
\hhline{~|-|-|-|-|~|~|}
массива & 12 & 8 & 4 & 1 & печать  & файла\\
\hline
\hline
& 0.256 & 0.188 & 0.181 & 0.652 & 3.445  &\\
\hhline{~|-|-|-|-|-|}
$10^7$ & 0.252 & 0.157 & 0.159 & 0.604 & 3.322  & 24 MB / 187 MB \\
\hhline{~|-|-|-|-|-|}
& 0.261 & 0.172 & 0.168 & 0.661 & 3.460  &\\
\hline
& 1.284 & 0.818 & 0.843 & 2.983 & 16.91  &\\
\hhline{~|-|-|-|-|-|}
$5 \cdot 10^7$ & 1.247 & 0.801 & 0.841 & 3.067 & 17.30  & 123 MB / 936 MB\\
\hhline{~|-|-|-|-|-|}
& 1.262 & 0.794 & 0.833 & 2.875 & 16.96 & \\
\hline
& 2.441 & 1.676 & 1.748 & 6.056 & 36.19 &\\
\hhline{~|-|-|-|-|-|}
$10^8$ & 2.453 & 1.720 & 1.678 & 5.959 & 36.38  & 245 MB / 1.8 GB\\
\hhline{~|-|-|-|-|-|}
& 2.505 & 1.709 & 1.689 & 6.039 &  36.41  &\\
\hline
& 12.57 & 8.281 & 8.354 & 31.50 & 182.22  &\\
\hhline{~|-|-|-|-|-|}
$5 \cdot 10^8$ & 12.56 & 8.276 & 8.346 & 31.29 & 182.00  & 1.2 GB / 9.4 GB\\
\hhline{~|-|-|-|-|-|}
& 12.75  & 8.364 & 8.418 & 31.69 & 183.52  &\\
\hline
\hline
\end{tabular}
\\\vspace{10pt}
\small{Таблица 5.}
\end{center}
Среднее ускорение приведено в Таблице 6.

\begin{center}
\begin{tabular}{||c|c|c|c|c||}
\hline
\hline
Размер & \multicolumn{4}{c|}{Число потоков}\\
\hhline{~|-|-|-|-|}
массива & 12 & 8 & 4 & 1 \\
\hline
$10^7$  & 13.30 & 19.78 & 20.13 & 5.33 \\
\hline
$5 \cdot 10^7$ & 13.49 & 21.21 & 20.32 & 5.74 \\
\hline
$10^8$ &14.73 & 21.34 & 21.31 & 6.03 \\
\hline
$5 \cdot 10^8$ &14.4 & 21.98 & 21.81 & 5.80 \\
\hline
\hline
\end{tabular}
\\\vspace{10pt}
\small{Таблица 6.}
\end{center}

Если сравнить эту таблицу с аналогичной в предыдущем пункте, то можно заметить, что ускорения возросли.
Это произошло за счет того, что благодаря записи со звездами, заметно уменьшился и размер выходного файла, а как следствие уменьшилось и время работы.

\subsection{Тест 4. Огромные массивы} \label{subsec2:3}
Здесь, как и в первом случае, числа будут генерироваться случайным образом.
Сравнивать будем стандартную печать и алгоритм, запущенный на 12 (+2) потоках.

Помимо обычного запуска, проведем и запуск с записью не на диск, а в разделяемую память \textit{shared-memory}.
Как известно, разделяемая память является самым быстром средством обмена данными между проессами.

Ранее говорилось, что скорость диска влияет на печать, но не всегда сильно.
Засчет сравнения записи на диск и в \textit{shared-memory} можно оценить, это влияние.

Далее на Рисунке \ref{grap} приведена зависимость времени работы от размера массива.
\begin{figure}[h!]
\center{\includegraphics[width=1\linewidth]{./pics/graphics.png}}
\caption{
1 -- стандартная печать с записью на диск;
2 -- стандартная печать с записью в разделяемую память;
3 -- алгоритм параллельной печати с записью на диск;
4 -- алгоритм параллельной печати с записью в разделяемую память.} \label{grap}
\end{figure}

Сначала хочется заметить, что стандартная печать не сильно замедляется при записи в диск. 
Все время скорость работы диска была порядка 40--50 Mb/s.
Диск фактически не оказывает никакого существенного влияния на работу.

Из графиков также видно, что при записи в \textit{shared-memory} отношение времени работы стандартного алгоритма и ускоренного постоянно, так как оба графика -- прямые.
Это значит, что ускорение одинакого на всех данных.

Однако, такого нельзя сказать в случае записи на диск.
На графике в точке $4 \cdot 10^8$ (9.6 GB) происходит излом: начинает ощущаться влияние диска. Именно это мы и наблюдали в Тесте 1 -- ускорение немного упало при $5 \cdot 10^8$.
С этого момента печать начинает упираться в диск.
При запуске тестов было замечено, что скорость записи на диск временами достигает 800-900 Mb/s.
Из-за слишком больших файлов (так файл при размере массива $10^9$ достигает 24 GB) создается очередь из буфферов на печать.
Потоки-обработчики обрабатывают буфферы быстрее, чем производится сама печать.
Разница между третьим и четвертым графиком -- накладные расходы на работу диска.

\subsection{Тестирование на реальных моделях}
?????

\vspace{10pt}

\begin{tabular}{||l||c|c|c||}
\hline
\hline
& Время работы & Время работы & Ускорение \\
\hline
\hline
COORD & 0.028 & 0.003 & 9.33 \\
\hline
ZCORN & 0.135 & 0.013 & 10.38 \\
\hline
COORD & 0.132 &  0.010 & 13.2 \\
\hline
ZCORN & 12.819 & 0.982 & 13.05 \\
\hline
\hline
\end{tabular}

